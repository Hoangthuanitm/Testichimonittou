<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Samurai Japanese Center - Kiểm tra Kaiwa</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #1E3A8A;
            --success: #10B981;
            --info: #3B82F6;
            --gray: #6B7280;
            --light: #F9FAFB;
            --white: #FFFFFF;
            --border: #D1D5DB;
        }
        * { box-sizing: border-box; }
        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--light);
            color: #1F2937;
        }
        header {
            background-color: var(--primary);
            color: white;
            text-align: center;
            padding: 1.5rem;
        }
        header h1 {
            margin: 0;
            font-size: 1.8rem;
            font-weight: 700;
        }
        main {
            max-width: 900px;
            margin: 2rem auto;
            padding: 0 1rem;
        }
        section {
            margin-bottom: 2rem;
        }
        h2 {
            color: var(--primary);
            font-size: 1.4rem;
            margin-top: 0;
        }
        label {
            font-weight: 500;
            display: block;
            margin-bottom: 0.5rem;
            color: #374151;
        }
        input, select, textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 5px;
            font-size: 1rem;
            transition: border 0.2s;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(30, 58, 138, 0.1);
        }
        select:disabled {
            background-color: #E5E7EB;
            cursor: not-allowed;
            opacity: 0.7;
        }
        #question-container {
            background-color: var(--white);
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: none;
        }
        #current-question {
            font-size: 1.25rem;
            margin-bottom: 1rem;
            font-weight: 500;
            line-height: 1.6;
        }
        #question-progress {
            font-style: italic;
            color: var(--gray);
            margin-bottom: 1rem;
        }
        button, .btn-link {
            display: inline-block;
            background-color: var(--success);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            text-decoration: none;
            text-align: center;
            transition: background-color 0.3s;
            margin-right: 1rem;
            margin-top: 1rem;
        }
        button:hover, .btn-link:hover {
            background-color: #059669;
        }
        button:disabled {
            background-color: #D1D5DB;
            cursor: not-allowed;
        }
        .btn-link {
            background-color: var(--info);
        }
        .btn-link:hover {
            background-color: #2563EB;
        }
        footer {
            text-align: center;
            padding: 1.5rem;
            background-color: var(--primary);
            color: white;
            font-size: 0.9rem;
            margin-top: 3rem;
        }
        ruby { ruby-align: center; }
        rt { font-size: 0.6em; color: #555; }
        @media (max-width: 600px) {
            header h1 { font-size: 1.5rem; }
            button, .btn-link { width: 100%; margin-right: 0; }
        }
    </style>
</head>
<body>
    <header>
        <h1>Samurai Japanese Center - Kiểm tra Kaiwa</h1>
    </header>
    <main>
        <section>
            <h2>Thông tin học viên</h2>
            <label for="student-name">Họ và Tên:</label>
            <input type="text" id="student-name" placeholder="Nhập họ và tên" required>
            <label for="student-class">Lớp:</label>
            <input type="text" id="student-class" placeholder="Nhập lớp" required>
        </section>
        <section>
            <label for="lesson-select">Chọn bài học:</label>
            <select id="lesson-select" disabled>
                <option value="">-- Chọn bài --</option>
                <option value="1">Bài 1</option>
                <option value="3">Bài 3</option>
                <option value="4">Bài 4</option>
                <option value="5">Bài 5</option>
                <option value="6">Bài 6</option>
                <option value="7">Bài 7</option>
                <option value="8">Bài 8</option>
                <option value="9">Bài 9</option>
                <option value="10">Bài 10</option>
                <option value="11">Bài 11</option>
                <option value="12">Bài 12</option>
                <option value="13">Bài 13</option>
                <option value="14">Bài 14</option>
                <option value="15">Bài 15</option>
                <option value="16">Bài 16</option>
                <option value="17">Bài 17</option>
                <option value="18">Bài 18</option>
                <option value="19">Bài 19</option>
                <option value="20">Bài 20</option>
                <option value="21">Bài 21</option>
                <option value="22">Bài 22</option>
                <option value="23">Bài 23</option>
                <option value="24">Bài 24</option>
                <option value="25">Bài 25</option>
                <option value="26">Bài 26</option>
                <option value="27">Bài 27</option>
                <option value="28">Bài 28</option>
                <option value="29">Bài 29</option>
                <option value="30">Bài 30</option>
                <option value="31">Bài 31</option>
                <option value="32">Bài 32</option>
                <option value="33">Bài 33</option>
                <option value="34">Bài 34</option>
                <option value="35">Bài 35</option>
            </select>
            <div>
                <button id="start-test-btn">Bắt đầu kiểm tra</button>
                <a href="history.html" id="show-history-btn" class="btn-link" target="_blank">
                    Lịch sử kiểm tra
                </a>
            </div>
        </section>
        <section id="question-container">
            <h2>Câu hỏi</h2>
            <div id="current-question"></div>
            <div id="question-progress"></div>
            <textarea id="answer-input" placeholder="Nhập câu trả lời của bạn..." rows="4"></textarea>
            <div id="answer-buttons">
                <button id="check-answer-btn">Trả lời</button>
            </div>
            <button id="complete-button" style="display: none;">Hoàn thành</button>
        </section>
    </main>
    <footer>
        <p>Tài liệu kiểm tra © 2025 thiết kế bởi Thuận</p>
    </footer>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
        import { getFirestore, collection, addDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyAfy4QMD9_7PyFHpInNdKDRWuW4AYCtLJ4",
            authDomain: "history-e4633.firebaseapp.com",
            projectId: "history-e4633",
            storageBucket: "history-e4633.firebasestorage.app",
            messagingSenderId: "331974436893",
            appId: "1:331974436893:web:10c3c6adf7b66d2b5fbef4",
            measurementId: "G-DC055090BW"
        };

        let db = null;
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
        } catch (error) {
            console.error("Lỗi khởi tạo Firebase:", error);
            alert("Không thể kết nối cơ sở dữ liệu. Vui lòng kiểm tra mạng!");
        }

        const questions = {
            1: [
                { text: "お名前は何ですか。", furigana: [] },
                { text: "お<ruby>国<rt>くに</rt></ruby>はどちらですか。", furigana: [["国", "くに"]] },
                { text: "<ruby>会社<rt>かいしゃ</rt></ruby>の名前は何ですか。", furigana: [["会社", "かいしゃ"]] },
                { text: "<ruby>組合<rt>くみあい</rt></ruby>の名前は何ですか。", furigana: [["組合", "くみあい"]] },
                { text: "あなたの<ruby>仕事<rt>しごと</rt></ruby>は何ですか。", furigana: [["仕事", "しごと"]] },
                { text: "あなたは<ruby>実習生<rt>じっしゅうせい</rt></ruby>ですか。", furigana: [["実習生", "じっしゅうせい"]] },
                { text: "<ruby>今年<rt>ことし</rt></ruby>は何<ruby>歳<rt>さい</rt></ruby>ですか。", furigana: [["今年", "ことし"], ["歳", "さい"]] }
            ],
            // ... (Các bài khác giữ nguyên như bạn đã có)
            // Do giới hạn độ dài, mình chỉ để 1 bài mẫu. Bạn giữ nguyên phần questions như cũ.
        };

        // === DOM Elements ===
        const lessonSelect = document.getElementById('lesson-select');
        const startTestBtn = document.getElementById('start-test-btn');
        const questionContainer = document.getElementById('question-container');
        const currentQuestion = document.getElementById('current-question');
        const questionProgress = document.getElementById('question-progress');
        const answerInput = document.getElementById('answer-input');
        const checkAnswerBtn = document.getElementById('check-answer-btn');
        const completeButton = document.getElementById('complete-button');
        const studentNameInput = document.getElementById('student-name');
        const studentClassInput = document.getElementById('student-class');

        let currentLesson = null;
        let currentQuestionIndex = 0;
        let studentAnswers = [];

        // === Enable lesson select when info filled ===
        studentNameInput.addEventListener('input', checkStudentInfo);
        studentClassInput.addEventListener('input', checkStudentInfo);

        function checkStudentInfo() {
            lessonSelect.disabled = !(studentNameInput.value.trim() && studentClassInput.value.trim());
        }

        // === Start Test ===
        startTestBtn.addEventListener('click', () => {
            if (!lessonSelect.value) {
                alert('Vui lòng chọn bài học!');
                return;
            }
            currentLesson = lessonSelect.value;
            currentQuestionIndex = 0;
            studentAnswers = [];
            questionContainer.style.display = 'block';
            startTestBtn.disabled = true;
            lessonSelect.disabled = true;
            showQuestion();
        });

        // === Show Question ===
        function showQuestion() {
            if (currentQuestionIndex < questions[currentLesson].length) {
                const q = questions[currentLesson][currentQuestionIndex];
                currentQuestion.innerHTML = q.text;
                questionProgress.textContent = `Câu ${currentQuestionIndex + 1}/${questions[currentLesson].length}`;
                answerInput.value = '';
                checkAnswerBtn.style.display = 'inline-block';
                completeButton.style.display = 'none';
            } else {
                checkAnswerBtn.style.display = 'none';
                completeButton.style.display = 'inline-block';
            }
        }

        // === Submit Answer ===
        checkAnswerBtn.addEventListener('click', () => {
            const answer = answerInput.value.trim();
            if (!answer) {
                alert('Vui lòng nhập câu trả lời!');
                return;
            }
            studentAnswers.push({
                question: questions[currentLesson][currentQuestionIndex].text,
                answer: answer
            });
            currentQuestionIndex++;
            showQuestion();
        });

        // === Complete Test ===
        completeButton.addEventListener('click', async () => {
            const testData = {
                studentName: studentNameInput.value.trim(),
                studentClass: studentClassInput.value.trim(),
                lesson: currentLesson,
                answers: studentAnswers,
                timestamp: serverTimestamp()
            };

            try {
                await addDoc(collection(db, 'testHistoryKaiwa'), testData);
                alert('Hoàn thành! Kết quả đã được lưu.');
                resetTest();
            } catch (error) {
                console.error("Lỗi lưu:", error);
                alert('Lỗi lưu kết quả. Vui lòng thử lại!');
            }
        });

        function resetTest() {
            questionContainer.style.display = 'none';
            startTestBtn.disabled = false;
            lessonSelect.disabled = false;
            lessonSelect.value = '';
            currentLesson = null;
            currentQuestionIndex = 0;
            studentAnswers = [];
        }

        // Load full questions object here if needed (giữ nguyên như bạn có)
        // ... (dán toàn bộ object questions từ file cũ vào đây)
    </script>
</body>
</html>
