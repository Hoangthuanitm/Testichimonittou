<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Samurai Japanese Center - Kiểm tra Kaiwa</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #F9FAFB;
        }

        header {
            background-color: #1E3A8A;
            color: white;
            text-align: center;
            padding: 1.5rem;
        }

        header h1 {
            margin: 0;
            font-size: 2rem;
            font-weight: 700;
        }

        main {
            max-width: 900px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        section {
            margin-bottom: 2rem;
        }

        label {
            font-weight: 500;
            display: block;
            margin-bottom: 0.5rem;
        }

        input, select, textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #D1D5DB;
            border-radius: 5px;
            font-size: 1rem;
            box-sizing: border-box;
        }

        select:disabled {
            background-color: #E5E7EB;
            cursor: not-allowed;
        }

        #question-container, #history-container {
            background-color: #FFFFFF;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        #current-question {
            font-size: 1.25rem;
            margin-bottom: 1rem;
            font-weight: 500;
        }

        #question-progress {
            font-style: italic;
            color: #6B7280;
            margin-bottom: 1rem;
        }

        button {
            background-color: #10B981;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: background-color 0.3s;
            margin-right: 1rem;
            margin-top: 1rem;
        }

        button:hover {
            background-color: #059669;
        }

        button:disabled {
            background-color: #D1D5DB;
            cursor: not-allowed;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        th, td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #E5E7EB;
        }

        th {
            background-color: #F3F4F6;
            font-weight: 500;
        }

        footer {
            text-align: center;
            padding: 1.5rem;
            background-color: #1E3A8A;
            color: white;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <header>
        <h1>Samurai Japanese Center - Kiểm tra Kaiwa</h1>
    </header>
    <main>
        <section>
            <h2>Thông tin học viên</h2>
            <label for="student-name">Họ và Tên:</label>
            <input type="text" id="student-name" placeholder="Nhập họ và tên" required>
            <label for="student-class">Lớp:</label>
            <input type="text" id="student-class" placeholder="Nhập lớp" required>
        </section>
        <section>
            <label for="lesson-select">Chọn bài học:</label>
            <select id="lesson-select" disabled>
                <option value="">-- Chọn bài --</option>
                <option value="1">Bài 1</option>
                <option value="3">Bài 3</option>
                <option value="4">Bài 4</option>
                <option value="5">Bài 5</option>
                <option value="6">Bài 6</option>
                <option value="7">Bài 7</option>
                <option value="8">Bài 8</option>
                <option value="9">Bài 9</option>
                <option value="10">Bài 10</option>
                <option value="11">Bài 11</option>
                <option value="12">Bài 12</option>
                <option value="13">Bài 13</option>
                <option value="14">Bài 14</option>
                <option value="15">Bài 15</option>
                <option value="16">Bài 16</option>
                <option value="17">Bài 17</option>
                <option value="18">Bài 18</option>
                <option value="19">Bài 19</option>
                <option value="20">Bài 20</option>
                <option value="21">Bài 21</option>
                <option value="22">Bài 22</option>
                <option value="23">Bài 23</option>
                <option value="24">Bài 24</option>
                <option value="25">Bài 25</option>
                <option value="26">Bài 26</option>
                <option value="27">Bài 27</option>
                <option value="28">Bài 28</option>
                <option value="29">Bài 29</option>
                <option value="30">Bài 30</option>
                <option value="31">Bài 31</option>
                <option value="32">Bài 32</option>
                <option value="33">Bài 33</option>
                <option value="34">Bài 34</option>
                <option value="35">Bài 35</option>
                <option value="36">Bài 36</option>
                <option value="37">Bài 37</option>
                <option value="38">Bài 38</option>
                <option value="39">Bài 39</option>
                <option value="40">Bài 40</option>
                <option value="41">Bài 41</option>
                <option value="42">Bài 42</option>
                <option value="43">Bài 43</option>
                <option value="44">Bài 44</option>
                <option value="45">Bài 45</option>
                <option value="46">Bài 46</option>
                <option value="47">Bài 47</option>
                <option value="48">Bài 48</option>
                <option value="49">Bài 49</option>
                <option value="50">Bài 50</option>
            </select>
            <div>
                <button onclick="startTest()" aria-label="Bắt đầu kiểm tra">Bắt đầu kiểm tra</button>
                <button onclick="showHistory()" aria-label="Xem lịch sử kiểm tra">Lịch sử kiểm tra</button>
            </div>
        </section>
        <section id="question-container" style="display: none;">
            <h2>Câu hỏi</h2>
            <div id="current-question"></div>
            <div id="question-progress"></div>
            <textarea id="answer-input" placeholder="Nhập câu trả lời của bạn..."></textarea>
            <div id="answer-buttons">
                <button onclick="checkAnswer()" aria-label="Gửi câu trả lời">Trả lời</button>
            </div>
            <button id="complete-button" onclick="completeTest()" aria-label="Hoàn thành bài kiểm tra" style="display: none;">Hoàn thành</button>
        </section>
        <section id="history-container" style="display: none;">
            <table id="history-table">
                <thead>
                    <tr>
                        <th>Thời gian</th>
                        <th>Tên bài</th>
                        <th>Họ và Tên</th>
                        <th>Lớp</th>
                        <th>Câu hỏi</th>
                        <th>Câu trả lời</th>
                        <th>Phản hồi</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </section>
    </main>
    <footer>
        <p>Tài liệu kiểm tra © <span id="current-year"></span> thiết kế bởi Thuận</p>
    </footer>

    <!-- Firebase CDN -->
    <script type="module">
        // Import Firebase modular SDK
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, orderBy, query, serverTimestamp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAfy4QMD9_7PyFHpInNdKDRWuW4AYCtLJ4",
            authDomain: "history-e4633.firebaseapp.com",
            projectId: "history-e4633",
            storageBucket: "history-e4633.firebasestorage.app",
            messagingSenderId: "331974436893",
            appId: "1:331974436893:web:10c3c6adf7b66d2b5fbef4",
            measurementId: "G-DC055090BW"
        };

        // Initialize Firebase
        let db;
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
        } catch (error) {
            console.error("Lỗi khi khởi tạo Firebase:", error);
            alert("Không thể kết nối với cơ sở dữ liệu. Vui lòng kiểm tra kết nối mạng hoặc cấu hình Firebase!");
        }

        // Questions data
        const questions = {
            1: [
                "お名前は何ですか？",
                "おいくつですか？",
                "あなたは日本人ですか？",
                "あなたの国は何ですか？",
                "お父さんはおいくつですか？",
                "あなたは学生ですか？",
                "あなたは会社員ですか？",
                "あなたは先生ですか？"
            ],
            3: [
                "お家はどちらですか？",
                "あなたのボールペンはいくらですか？",
                "会社はどちらですか？",
                "学校はどこですか？",
                "あなたの家は１階ですか？",
                "駅はどこですか？"
            ],
            4: [
                "今何時ですか？",
                "あなたの誕生日はいつですか？",
                "会社は何時からですか？",
                "あなたは朝何時に起きますか？",
                "きのう何時に寝ましたか？",
                "サムライセンターは何時から何時までですか？",
                "日曜日に何時に来ますか？",
                "授業は何時に終わりますか？",
                "きのう何時に家に帰りましたか？",
                "お店は何時から何時までですか？",
                "サムライセンターの授業は何時ですか？",
                "きのう何をしましたか？",
                "休みは何曜日ですか？"
            ],
            5: [
                "どこへ行きますか？",
                "きのうどこへ行きましたか？",
                "きのう何時まで勉強しましたか？",
                "朝何時から何時まで勉強しますか？",
                "昼から夕方まで何をしますか？"
            ],
            7: [
                "もうご飯を食べましたか？",
                "スプーンでご飯を食べますか？",
                "誕生日にプレゼントをもらいましたか？",
                "お母さんの誕生日に何をあげましたか？",
                "クリスマスにプレゼントをもらいましたか？",
                "もう６時の授業が終わりましたか？",
                "友達に電話をかけましたか？",
                "もう昼ご飯を食べましたか？"
            ],
            8: [
                "センターの授業はどうですか？",
                "ホーチミンはどんなところですか？",
                "お父さんはどんな人ですか？",
                "お父さんはやさしいですか？",
                "ITMセンターの授業にもう慣れましたか？",
                "ベトナムはどんな国ですか？",
                "あなたの国はどんな国ですか？",
                "あなたの家はどうですか？",
                "ホーチミンはどんな街ですか？",
                "センターの先生はやさしいですか？",
                "あなたの学校はどうですか？"
            ],
            9: [
                "どんなスポーツが好きですか？",
                "どうして日本語を勉強しますか？",
                "あなたは歌が上手ですか？",
                "あなたは日本語がわかりますか？",
                "今、買い物がありますか？",
                "どんな映画が好きですか？",
                "どんな音楽が好きですか？",
                "サッカーが好きですか？",
                "どんな飲み物が好きですか？",
                "どんな食べ物が好きですか？どんな食べ物が嫌いですか？",
                "どんな本が好きですか？",
                "家にペットがいますか？"
            ],
            10: [
                "あなたの国に山がありますか？",
                "どこに住んでいますか？",
                "家に猫がいますか？",
                "国にATMがありますか？",
                "あなたの友達はどこに住んでいますか？",
                "学校に図書館がありますか？",
                "あなたの家族に誰がいますか？",
                "あなたの部屋にテレビがありますか？",
                "家に扇風機がありますか？",
                "会社に誰がいますか？",
                "あなたの学校に図書館がありますか？"
            ],
            11: [
                "何時に寝ますか？",
                "日本までどのくらい時間がかかりましたか？",
                "センターからあなたの家までバスでどのくらいかかりますか？",
                "あなたの家から会社までバスでかかりますか？",
                "どのくらい日本語を勉強できますか？",
                "家に部屋がいくつありますか？",
                "あなたのクラスは何人ですか？",
                "朝、何をしますか？",
                "クラスに日本人がいますか？",
                "クラスに外国人がいますか？"
            ],
            12: [
                "日本はどうでしたか？",
                "ベトナムでいつが好きですか？",
                "日本とベトナム、どちらが好きですか？",
                "クラスで誰が一番やさしいですか？",
                "サッカーとテニス、どちらが好きですか？",
                "ベトナムで何が好きですか？",
                "クラスで誰が日本語が上手ですか？",
                "熱いコーヒーと冷たいコーヒー、どちらが好きですか？",
                "お父さんとお母さん、どちらが料理が上手ですか？",
                "ベトナムで何が一番好きですか？",
                "ベトナムで何が面白いですか？",
                "ベトナムで何が好きですか？",
                "ベトナムでどこが好きですか？"
            ],
            13: [
                "日本語は面白いですか？",
                "日本語と英語、どちらが面白いですか？",
                "今週末、何をしたいですか？",
                "日本に住みたいですか？",
                "日本へ旅行に行きたいですか？",
                "日本へ勉強しに行きますか？",
                "誕生日に何をもらいたいですか？",
                "サムライセンターへ日本語を勉強しに来ましたか？",
                "昼ご飯を食べにどこへ行きますか？",
                "どんな人と話したいですか？"
            ],
            14: [
                "今、何を持っていますか？",
                "日本語を勉強していますか？",
                "本を読んでいますか？",
                "あなたの家族について教えてください。",
                "日本とベトナムの違いを教えてください。",
                "あなたの趣味を教えてください。"
            ],
            15: [
                "日本語を話していますか？",
                "バイクを運転していますか？",
                "パソコンを使っていますか？",
                "ここでタバコを吸ってもいいですか？",
                "ここで写真を撮ってもいいですか？",
                "あなたはどこに住んでいますか？",
                "ここでご飯を食べてもいいですか？",
                "センターでお茶を飲んでもいいですか？",
                "ここで寝てもいいですか？"
            ],
            16: [
                "家に帰ってから何をしますか？",
                "きのう、ご飯を食べてから何をしましたか？",
                "日本で３年住んで、ベトナムへ帰ってから何をしますか？",
                "日本の天気はどうですか？",
                "センターの授業はどうですか？",
                "ベトナムの食べ物はどうですか？",
                "日本へ行って、どこへ行きたいですか？"
            ],
            17: [
                "センターに毎日来なければなりませんか？",
                "日本に行きます。パスポートを持たなければなりませんか？",
                "毎朝センターに来なければなりませんか？",
                "宿題をしなければなりませんか？",
                "お腹が痛いです。病院に行かなければなりませんか？",
                "日本へ行くのにビザを取らなければならない？"
            ],
            18: [
                "日本語で話すことができますか？",
                "どんなスポーツをすることができますか？",
                "ピアノを弾けますか？",
                "あなたの仕事は何ですか？",
                "ご飯を食べる前に何をしますか？",
                "寝る前に何をしますか？",
                "ベトナムで日本語を話すことができますか？",
                "ベトナムで英語を話すことができますか？",
                "お茶を飲みたいですが、どこで飲むことができますか？",
                "日本へ行くのに何をしたいですか？"
            ],
            19: [
                "日本の文化を勉強しましたか？",
                "日本語が上手になりましたか？",
                "ダイエットをしたことがありますか？",
                "日本に行ったことがありますか？",
                "日本へ行ってから何をしたいですか？",
                "寿司を食べたことがありますか？",
                "ベトナムでどこへ行ったことがありますか？",
                "ハノイに行ったことがありますか？",
                "センターでタバコを吸ってはいけませんか？",
                "友達にプレゼントをあげたことがありますか？"
            ],
            20: [
                "日本語を話す？",
                "ベトナムで何が好き？",
                "漢字がいくつわかる？",
                "ベトナムと日本、どっちが面白い？",
                "日本語がわかる？",
                "きのうは天気がどうだった？",
                "日本語が話せる？",
                "ご飯を食べた？",
                "明日、ビールを飲まない？",
                "今、何を持っている？",
                "ご飯はどこに住んでいる？",
                "きのう、何だった？",
                "今、何してる？"
            ],
            21: [
                "日本語が難しいと思いますか？",
                "日本は楽しいと思いますか？",
                "日本の文化についてどう思いますか？",
                "ベトナムについてどう思いますか？",
                "ご飯を食べた後で寝ると思いますか？",
                "日本語と英語、どちらが難しいと思いますか？",
                "ベトナムでどこが楽しいと思いますか？",
                "寝る前に何をしますか？"
            ],
            22: [
                "あなたが生まれたところはどこですか？",
                "ほしいものは何ですか？",
                "今、電話をかけている人はいますか？",
                "飲むお茶がありますか？",
                "レストランで食べるのと家で食べるの、どちらが好きですか？",
                "初めて行った国はどこですか？",
                "今、着ている服はいつ買いましたか？",
                "今までに行ったことがある国はどこですか？",
                "お母さんが作った料理が好きですか？",
                "日本にいるうちに見たいものは何ですか？",
                "好きな食べ物は何ですか？嫌いな食べ物は何ですか？"
            ],
            23: [
                "日本へ行って、道がわからない、どうしますか？",
                "忙しい時、何をしますか？",
                "日本へ行くとき、荷物が重いですか？",
                "たくさんお酒を飲むと、どうなりますか？",
                "センターの近くにコンビニがありますか？",
                "家へ帰るとき、何で帰りますか？どのぐらいかかりますか？",
                "病気になったとき、薬を飲んでもいいですか？",
                "日本語がわからないとき、どうしますか？",
                "電話をかけるとき何と言いますか？",
                "忙しい時、何をしますか？",
                "疲れたとき、どうしますか？"
            ],
            24: [
                "あなたはお母さんにプレゼントをあげたいですか？",
                "お金がないとき、誰かに借りますか？",
                "あなたは誕生日にお母さんに何をしてあげますか？",
                "誕生日にお母さんにプレゼントをもらいましたか？",
                "お母さんが疲れたとき、あなたはどこを助けてあげますか？"
            ],
            25: [
                "いい天気だったら、どこへ旅行に行きたいですか？",
                "宿題が多かったら、どうしますか？",
                "日本語を話す仕事に就きたいですか？",
                "時間があれば、何をしたいですか？",
                "もし、お金がたくさんあったら、何をしたいですか？",
                "日本でも働きますか？",
                "日本へ行ったら、どこへ行きたいですか？",
                "チャンスがあったら、日本へ行きたいですか？",
                "日本語が上手くなかったら、どうしますか？",
                "日本に友達がいなかったら、どうしますか？"
            ],
            26: [
                "ベトナムに行くんですが、どんなお土産を買ったらいいですか。",
                "家へ帰る時に、鍵を忘れたんですが、どうしたらいいですか。",
                "荷物が、運べないんですが、どうしたらいいですか。",
                "日本で働きたいのはどうしてですか。【～んです】",
                "今、部屋の掃除をしていますか。【～んです】",
                "日本で靴を買ったんですが、サイズに変えてもらいたいです。どう思いますか。",
                "高いお土産がありませんから、買ってもらいたいです。どう思いますか。"
            ],
            27: [
                "日本に初めて行った、すぐ仕事が変えられますか。",
                "日本で仕事ができますか。どんな仕事ができますか。",
                "あなたの国から仕事が変えられますか。",
                "歌や絵が描けますか。【Aは～が、Bは～】",
                "歌や絵が書けますか。【Aは～が、Bは～】"
            ],
            28: [
                "ギターを弾きながら、歌が歌えますか。",
                "休みなはいつも何をしていますか。",
                "子供の時、勉強が終わってから、よく何をしていましたか。",
                "見ずみなのは泳いだり、走ったりしていますか。",
                "日本についてどう思いますか。【～し、～し、それで～】",
                "どうして日本で働きたいですか。【～し、～し、それで～】"
            ],
            29: [
                "部屋が汚れていますか。",
                "部屋のが汚れていますか。汚れていますか。",
                "部屋の扇風機はどうなっていますか。",
                "先生に借りた本をなくしてしまったんですが、どうしたらいいですか。",
                "パスポートをなくしてしまったら、どうしたらいいですか。",
                "子供の時、鍵を忘れてしまったことがありますか。"
            ],
            30: [
                "旅行のに、どんなことを準備しておきますか。",
                "日本に行くに、どんな準備をしておいたらいいですか。",
                "荷物をまとめましょうか。",
                "あなたの部屋にベトナム国旗が貼ってありますか。",
                "あなたの部屋にカレンダーが掛けてありますか。",
                "部屋のにパソコンが置いてありますか。",
                "この部屋に何が置いてありますか。"
            ],
            31: [
                "日本は寒いか暑いがありますか。",
                "日本は食べ物にくです。あなたは？",
                "休みはどこかへ行くつもりですか。",
                "日本へ行ってからも、勉強を続けるつもりですか。",
                "仕事が終わって、日本へ行ったら、どんな仕事をするつもりですか。",
                "お母さんは日本へ行こうと思っています。あなたは？",
                "日本はまだ寒いです。あなたは勉強していますか。",
                "レベルの勉強を続けていますか。"
            ],
            32: [
                "荷物が運べないんですが、誰かに頼んだがいいですか。",
                "子供の時、宿題をやって行ったほうがいいですか。宿題をやって行ったほうがいいですか。",
                "日本は初めてなんですが、どんなことに気をつけたらいいですか。",
                "日本の仕事は慣れるでしょうか。",
                "日本の仕事はどうなると思いますか。"
            ],
            33: [
                "「故障」はどういう意味ですか。",
                "「使用禁止」はどういう意味ですか。",
                "「立入禁止」はどういう意味ですか。",
                "「無料」はどういう意味ですか。",
                "日本はスポーツので「練習」という言葉を使います。あなたの国でどんな言葉を使いますか。",
                "友達が日本に行きました。これから、新しい仕事を始めるんですが、どんな言葉を使いますか。"
            ],
            34: [
                "仕事が終わった後で、何をしていますか。",
                "勉強が終わった後で、何をしていますか。",
                "宿題しないで、遊んだことがありますか。",
                "ご飯を食べないで、学校へ行ったことがありますか。",
                "シャワーを浴びないで、寝たことがありますか。",
                "あなたの国ではお正月にどんな準備をしてきますか。",
                "朝、宿題をしていて、寝ますか。"
            ],
            35: [
                "たくさんお金があれば、何をしたいですか。",
                "靴を買いたいんですが、どこの靴がいいですか。",
                "あなたの国ではお正月にどんな準備をてけばいいですか。",
                "ベトナムの旅行に行くんですが、いくらお金を準備すればいいですか。",
                "ベトナム旅行したいんですが、時期がいいですか。",
                "早く仕事になりたいんですが、どうすればいいですか。",
                "いいの、お金が足りなければ、どうしますか。"
            ],
            36: [
                "もう日本の生活に慣れましたか。",
                "友達と仲良く話すようにしていますか。",
                "買った物を忘れないようにしていますか。",
                "早く仕事になるように、どうすればいいですか。",
                "日本のラッシュはひどいです。遅れないように、どうすればいいと思いますか。",
                "日本で事故にならないように、どんなに気をつけますか。",
                "日本に事故にあわないように、どうすればいいと思いますか。"
            ],
            37: [
                "子供の時、親に怒られたことがありますか。",
                "何か親に褒められたことがありますか。",
                "日本の、パスポートを盗られたら、どうしますか。",
                "親に悪いことを言われたことがありますか。",
                "親にいいことを言われたら、どうしますか。",
                "ベトナムから日本へどんな物が送られていますか。",
                "日本からベトナムへどんな物が送られていますか。"
            ],
            38: [
                "絵を描くのが好きですか。",
                "アメリカやヨーロッパのに住むのが好きですか。",
                "料理を作るのはどう思いますか。",
                "あなたが生まれたのはどこですか。",
                "日本語を勉強しているのはどうしてですか。",
                "一番楽しいのは何ですか。",
                "大切なのは何だと思いますか。"
            ],
            39: [
                "ラッシュで電車のに遅れたことがありますか。",
                "電車が遅れで遅れなくなったことがよくありますか。",
                "世界でたばこで死んでしまう人が多いのをしっていますか。",
                "親に言えなくて、難しいはどうしますか。",
                "「遅刻」がのがわからないので、誰かに教えていただけますか。",
                "「地理」もわからないので、教えてを教えていただけますか。"
            ],
            40: [
                "ベトナムの食べ物は辛いか知っていますか。",
                "ベトナムの旅行にどんな物があるか教えてください。",
                "あなたが好きに国は日本のどこにあるか知っていますか。",
                "初めて行った人に話しているかどうか聞くのは失礼だと思いますか。",
                "あなたの国は食べ物が辛いか教えてください。",
                "日本へ行ってから、どこに行ってみたいですか。",
                "日本で日本語をやってみたいですか。"
            ],
            41: [
                "親に早く帰ってもらいたい、と思いますか。",
                "カップが汚いので、誰かに洗い替えてもらいたい、と思いますか。",
                "ちょっと忙しいので、誰かを手伝ってもらいたい、と思いますか。",
                "誰かのお土産を食べてくれたことがありますか。",
                "あなたのヘルメットがなくなりました。誰かに借りたいです。どう思いますか。",
                "ベトナムの旅行に誰かに荷物を手伝ってあげますか。"
            ],
            42: [
                "日本語を覚えるために、どんなことをしたらいいですか。",
                "安全のために、何か気をつけていますか。",
                "勉強のために、どこへ行きますか。",
                "仕事が上手く話せるように、どんなことをすればいいですか。",
                "やかんはどこに置きますか。",
                "ふろしきはどこに置くか使いますか。",
                "あなたの国でバイクを買うのにいくらぐらいかかりますか。"
            ],
            43: [
                "旅行にいくベトナムはこれから変えそうですか。",
                "楽しそうですね。何かいいことがあったんですか。",
                "コーヒーを買ってきてくれませんか。"
            ],
            44: [
                "お酒を飲みすぎたことがありますか。",
                "食べすぎて、お腹のが悪くなったことがありますか。",
                "あなたの国は食べやすいですか。",
                "日本は食べにくいと思いますか。",
                "誰かに食べくしてもらいたい、と思いますか。",
                "食べ物が辛すぎて、よく食べません。どう思いますか。",
                "忙しいのです。プレゼントは誰かにあげますか。"
            ],
            45: [
                "ベトナムでは親が死にたは、誰に話しますか。",
                "日本では親の死には、誰に話しますか。",
                "病気や怪我を治すは、どうしますか。",
                "子供の時、鍵をなくしたは、どこに話したらいいですか。",
                "頭が痛いし、熱もあります。薬を飲んだのに、なかなか治りません。どうしますか。",
                "新しい仕事があります。薬を食べたのに、頭が治りません。どうしますか。",
                "ボタンを押したのに、電気がきません。誰に話しますか。"
            ],
            46: [
                "ご飯食べたあとで、友達に話に呼ばれました。どう思いますか。",
                "日本の食べ物を食べたばかりのは辛いと思いましたか。",
                "サムライセンターに行ったばかりの、何か変わったことがありましたか。",
                "買ったばかりのスマホが壊れました。どうしますか。"
            ],
            47: [
                "あなたはクラスで勉強が上手だそうですが、ほんとうですか。",
                "日本に行きそうですが、いつ行きますか。",
                "天気予報によると、今日の天気はどうなりますか。"
            ],
            48: [
                "子供が泣いたら、誰を話せようと思いますか。",
                "子供が勉強をやめたいと言ったら、やめさせますか。",
                "お母さんを泣かせたことがありますか。",
                "お父さんをがっかりさせたことがありますか。",
                "仕事で疲れくなって、早く帰りたい、と思いますか。"
            ],
            49: [
                "お名前は何とおっしゃいますか。",
                "ご家族はどちらにいらっしゃいますか。",
                "いつ日本へ行かれますか。",
                "よく勉強をごぞんになりますか。",
                "今、どこかいらっしゃいますか。",
                "お酒を少しがりますか。",
                "日本の食べ物をごぞじですか。",
                "今、勉強をなさいますか。"
            ],
            50: [
                "お名前は何とおっしゃいますか。",
                "どちらに住んでいらっしゃいますか。",
                "日本はどのぐらい行かれましたか。",
                "お仕事においでいらっしゃいますか。"
            ]
        };

        let currentLesson = null;
        let currentQuestionIndex = 0;

        // Set dynamic year in footer
        document.getElementById('current-year').textContent = new Date().getFullYear();

        // Sanitize text to prevent XSS
        function sanitizeText(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Check student information
        function checkStudentInfo() {
            const studentName = document.getElementById('student-name').value.trim();
            const studentClass = document.getElementById('student-class').value.trim();
            const lessonSelect = document.getElementById('lesson-select');

            lessonSelect.disabled = !(studentName && studentClass);
        }

        // Initialize event listeners
        document.addEventListener('DOMContentLoaded', function() {
            const lessonSelect = document.getElementById('lesson-select');
            lessonSelect.addEventListener('change', loadQuestions);

            const studentNameInput = document.getElementById('student-name');
            const studentClassInput = document.getElementById('student-class');
            studentNameInput.addEventListener('input', checkStudentInfo);
            studentClassInput.addEventListener('input', checkStudentInfo);
        });

        function loadQuestions() {
            const lessonSelect = document.getElementById("lesson-select");
            currentLesson = lessonSelect.value;
        }

        function displayCurrentQuestion() {
            const currentQuestionDiv = document.getElementById("current-question");
            const questionProgress = document.getElementById("question-progress");
            const answerButtons = document.getElementById("answer-buttons");
            const completeButton = document.getElementById("complete-button");

            if (questions[currentLesson] && currentQuestionIndex < questions[currentLesson].length) {
                currentQuestionDiv.innerHTML = sanitizeText(questions[currentLesson][currentQuestionIndex]);
                questionProgress.innerHTML = `Câu ${currentQuestionIndex + 1}/${questions[currentLesson].length}`;
                answerButtons.style.display = 'block';
                completeButton.style.display = 'none';
            } else {
                currentQuestionDiv.innerHTML = "Hoàn thành bài học!";
                questionProgress.innerHTML = "";
                answerButtons.style.display = 'none';
                completeButton.style.display = 'block';
            }
        }

        function startTest() {
            const studentName = document.getElementById('student-name').value.trim();
            const studentClass = document.getElementById('student-class').value.trim();
            const lessonSelect = document.getElementById('lesson-select').value;
            const answerInput = document.getElementById('answer-input');

            if (!studentName || !studentClass) {
                alert("Vui lòng nhập họ và tên và lớp!");
                return;
            }

            if (!lessonSelect) {
                alert("Vui lòng chọn bài học!");
                return;
            }

            currentQuestionIndex = 0;
            answerInput.value = "";
            document.getElementById('question-container').style.display = 'block';
            displayCurrentQuestion();
        }

        async function checkAnswer() {
            const studentName = document.getElementById('student-name').value.trim();
            const studentClass = document.getElementById('student-class').value.trim();
            const answerInput = document.getElementById('answer-input').value.trim();

            if (!studentName || !studentClass) {
                alert("Vui lòng nhập họ và tên và lớp!");
                return;
            }

            if (answerInput === "") {
                alert("Vui lòng nhập câu trả lời!");
                return;
            }

            if (!db) {
                alert("Không thể kết nối với cơ sở dữ liệu. Vui lòng thử lại sau!");
                return;
            }

            if (currentLesson && questions[currentLesson][currentQuestionIndex]) {
                try {
                    await addDoc(collection(db, 'testHistoryKaiwa'), {
                        name: studentName,
                        class: studentClass,
                        lesson: currentLesson,
                        question: questions[currentLesson][currentQuestionIndex],
                        answer: answerInput,
                        feedback: "",
                        timestamp: serverTimestamp()
                    });
                    if (currentQuestionIndex < questions[currentLesson].length - 1) {
                        currentQuestionIndex++;
                        document.getElementById('answer-input').value = "";
                        displayCurrentQuestion();
                    } else {
                        document.getElementById("answer-buttons").style.display = 'none';
                        document.getElementById("complete-button").style.display = 'block';
                    }
                } catch (error) {
                    console.error("Lỗi khi lưu câu trả lời:", error);
                    alert(`Đã xảy ra lỗi khi lưu câu trả lời: ${error.message}`);
                }
            }
        }

        function completeTest() {
            // Reset test state
            document.getElementById('question-container').style.display = 'none';
            document.getElementById('answer-input').value = '';
            document.getElementById('lesson-select').value = '';
            currentQuestionIndex = 0;
            currentLesson = null;
            alert('Bài kiểm tra đã hoàn thành!');
        }

        async function loadHistory() {
            const historyTableBody = document.querySelector("#history-table tbody");
            historyTableBody.innerHTML = "";

            if (!db) {
                console.error("Firestore chưa được khởi tạo.");
                alert("Không thể tải lịch sử: Kết nối cơ sở dữ liệu thất bại!");
                return;
            }

            try {
                const q = query(collection(db, 'testHistoryKaiwa'), orderBy('timestamp', 'desc'));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    historyTableBody.innerHTML = '<tr><td colspan="7">Chưa có lịch sử trả lời.</td></tr>';
                    return;
                }

                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    const row = document.createElement('tr');
                    const timestamp = data.timestamp && data.timestamp.toDate
                        ? new Date(data.timestamp.toDate()).toLocaleString('vi-VN')
                        : 'N/A';
                    row.innerHTML = `
                        <td>${timestamp}</td>
                        <td>${sanitizeText(data.lesson || 'N/A')}</td>
                        <td>${sanitizeText(data.name || 'N/A')}</td>
                        <td>${sanitizeText(data.class || 'N/A')}</td>
                        <td>${sanitizeText(data.question || 'N/A')}</td>
                        <td>${sanitizeText(data.answer || 'N/A')}</td>
                        <td>${sanitizeText(data.feedback || 'Chưa có phản hồi')}</td>
                    `;
                    historyTableBody.appendChild(row);
                });
            } catch (error) {
                console.error("Lỗi khi tải lịch sử:", error);
                let errorMessage = "Đã xảy ra lỗi khi tải lịch sử!";
                if (error.code === 'permission-denied') {
                    errorMessage = "Không có quyền truy cập dữ liệu. Vui lòng kiểm tra cấu hình Firestore!";
                } else if (error.code === 'unavailable') {
                    errorMessage = "Không thể kết nối với Firestore. Vui lòng kiểm tra mạng!";
                }
                alert(errorMessage);
            }
        }

        function showHistory() {
            window.location.href = 'history.html';
        }

        // Expose functions to global scope for onclick handlers
        window.startTest = startTest;
        window.checkAnswer = checkAnswer;
        window.completeTest = completeTest;
        window.showHistory = showHistory;
    </script>
</body>
</html>
