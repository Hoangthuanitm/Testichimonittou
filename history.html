<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Samurai Japanese Center - Lịch sử kiểm tra</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #1E3A8A;
            --success: #10B981;
            --danger: #EF4444;
            --info: #3B82F6;
            --gray: #6B7280;
            --light: #F9FAFB;
            --white: #FFFFFF;
            --border: #D1D5DB;
            --shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--light);
            color: #1F2937;
        }
        header {
            background-color: var(--primary);
            color: white;
            text-align: center;
            padding: 1.5rem;
            box-shadow: var(--shadow);
        }
        header h1 { font-size: 1.8rem; font-weight: 700; }
        main { max-width: 1100px; margin: 2rem auto; padding: 0 1rem; }
        .filter-section {
            background: var(--white);
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: var(--shadow);
            margin-bottom: 1.5rem;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        .filter-section label {
            display: block; font-weight: 500; margin-bottom: 0.5rem; color: #374151;
        }
        .filter-section input, .filter-section select {
            width: 100%; padding: 0.75rem; border: 1px solid var(--border);
            border-radius: 5px; font-size: 1rem;
        }
        .action-bar {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 1rem; flex-wrap: wrap; gap: 0.5rem;
        }
        .delete-btn {
            background-color: var(--danger); color: white; border: none;
            padding: 0.75rem 1.5rem; border-radius: 5px; cursor: pointer;
            font-weight: 500; transition: 0.3s;
        }
        .delete-btn:hover { background-color: #DC2626; }
        .delete-btn:disabled { background-color: #9CA3AF; cursor: not-allowed; }
        .table-container {
            overflow-x: auto; border-radius: 8px; box-shadow: var(--shadow);
            background: var(--white);
        }
        table { width: 100%; border-collapse: collapse; min-width: 1000px; }
        th, td { padding: 0.75rem 1rem; text-align: left; border-bottom: 1px solid #E5E7EB; font-size: 0.95rem; }
        th { background-color: #F3F4F6; font-weight: 600; position: sticky; top: 0; z-index: 10; }
        td { vertical-align: top; }
        .checkbox-column { width: 50px; text-align: center; }
        .feedback-btn {
            background-color: var(--info); color: white; border: none;
            padding: 0.4rem 0.8rem; border-radius: 4px; font-size: 0.85rem;
            cursor: pointer; margin-left: 0.5rem;
        }
        .feedback-btn:hover { background-color: #2563EB; }
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-content {
            background: var(--white); padding: 1.5rem; border-radius: 8px;
            width: 90%; max-width: 420px; box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .modal-content h2 { margin: 0 0 1rem; font-size: 1.3rem; color: var(--primary); }
        .modal-content input, .modal-content textarea {
            width: 100%; padding: 0.75rem; border: 1px solid var(--border);
            border-radius: 5px; margin-bottom: 1rem; font-size: 1rem;
        }
        .modal-content textarea { resize: vertical; min-height: 100px; }
        .modal-buttons { display: flex; justify-content: flex-end; gap: 0.5rem; }
        .modal-buttons button {
            padding: 0.5rem 1rem; border: none; border-radius: 5px; cursor: pointer; font-weight: 500;
        }
        .cancel-btn { background-color: #D1D5DB; color: #374151; }
        .cancel-btn:hover { background-color: #B0B7C0; }
        .confirm-btn { background-color: var(--danger); color: white; }
        .confirm-btn:hover { background-color: #DC2626; }
        .save-btn { background-color: var(--success); color: white; }
        .save-btn:hover { background-color: #059669; }
        footer {
            text-align: center; padding: 1.5rem; background-color: var(--primary);
            color: white; font-size: 0.9rem; margin-top: 3rem;
        }
        ruby { ruby-align: center; }
        rt { font-size: 0.6em; color: #555; }
        @media (max-width: 768px) {
            header h1 { font-size: 1.5rem; }
            .filter-section { grid-template-columns: 1fr; }
            .action-bar { flex-direction: column; align-items: stretch; }
            .delete-btn { width: 100%; }
            table { min-width: 800px; }
            th, td { font-size: 0.85rem; padding: 0.5rem; }
        }
    </style>
</head>
<body>
    <header>
        <h1>Samurai Japanese Center - Lịch sử kiểm tra Kaiwa</h1>
    </header>
    <main>
        <section class="filter-section">
            <div><label for="filter-date">Ngày:</label><input type="date" id="filter-date"></div>
            <div><label for="filter-class">Lớp:</label><input type="text" id="filter-class" placeholder="Nhập lớp"></div>
            <div><label for="filter-name">Họ và Tên:</label><input type="text" id="filter-name" placeholder="Nhập tên"></div>
            <div><label for="filter-lesson">Bài:</label>
                <select id="filter-lesson">
                    <option value="">-- Tất cả --</option>
                    <!-- Danh sách bài từ 1 đến 35 -->
                    <option value="1">Bài 1</option><option value="3">Bài 3</option><option value="4">Bài 4</option>
                    <!-- ... thêm đủ 35 bài -->
                </select>
            </div>
        </section>
        <section>
            <div class="action-bar">
                <button class="delete-btn" id="delete-btn">Xóa mục đã chọn</button>
            </div>
            <div class="table-container">
                <table id="history-table">
                    <thead>
                        <tr>
                            <th class="checkbox-column"><input type="checkbox" id="select-all"></th>
                            <th>Thời gian</th>
                            <th>Bài</th>
                            <th>Họ và Tên</th>
                            <th>Lớp</th>
                            <th>Câu hỏi</th>
                            <th>Câu trả lời</th>
                            <th>Phản hồi</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </section>

        <!-- Modal Xóa -->
        <div class="modal" id="password-modal">
            <div class="modal-content">
                <h2>Xác nhận xóa</h2>
                <input type="password" id="password-input" placeholder="Mật khẩu (112)">
                <div class="modal-buttons">
                    <button class="cancel-btn" id="cancel-btn">Hủy</button>
                    <button class="confirm-btn" id="confirm-delete-btn">Xóa</button>
                </div>
            </div>
        </div>

        <!-- Modal Phản hồi -->
        <div class="modal" id="feedback-modal">
            <div class="modal-content">
                <h2>Chỉnh sửa phản hồi</h2>
                <textarea id="feedback-input" rows="4" placeholder="Nhập phản hồi..."></textarea>
                <div class="modal-buttons">
                    <button class="cancel-btn" id="feedback-cancel-btn">Hủy</button>
                    <button class="save-btn" id="feedback-save-btn">Lưu</button>
                </div>
            </div>
        </div>
    </main>
    <footer>
        <p>Tài liệu kiểm tra © 2025 thiết kế bởi Thuận</p>
    </footer>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
        import { getFirestore, collection, getDocs, deleteDoc, doc, query, orderBy, updateDoc } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';

        const firebaseConfig = { /* Giữ nguyên như trên */ };
        let db;
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
        } catch (e) { alert("Lỗi kết nối Firebase!"); }

        // === Load & Filter ===
        async function loadHistory() {
            const tbody = document.querySelector("#history-table tbody");
            tbody.innerHTML = "<tr><td colspan='8'>Đang tải...</td></tr>";
            const filters = {
                date: document.getElementById("filter-date").value,
                class: document.getElementById("filter-class").value.trim().toLowerCase(),
                name: document.getElementById("filter-name").value.trim().toLowerCase(),
                lesson: document.getElementById("filter-lesson").value
            };

            try {
                const q = query(collection(db, 'testHistoryKaiwa'), orderBy('timestamp', 'desc'));
                const snapshot = await getDocs(q);
                tbody.innerHTML = "";

                let hasData = false;
                snapshot.forEach(doc => {
                    const d = doc.data();
                    const time = d.timestamp?.toDate();
                    const dateStr = time ? time.toISOString().split('T')[0] : '';
                    if ((filters.date && dateStr !== filters.date) ||
                        (filters.class && !d.studentClass?.toLowerCase().includes(filters.class)) ||
                        (filters.name && !d.studentName?.toLowerCase().includes(filters.name)) ||
                        (filters.lesson && d.lesson !== filters.lesson)) return;

                    hasData = true;
                    d.answers.forEach((a, i) => {
                        const row = document.createElement('tr');
                        row.dataset.id = doc.id;
                        row.innerHTML = `
                            <td class="checkbox-column"><input type="checkbox" class="row-checkbox"></td>
                            <td>${time ? time.toLocaleString('vi-VN') : 'N/A'}</td>
                            <td>Bài ${d.lesson}</td>
                            <td>${d.studentName}</td>
                            <td>${d.studentClass}</td>
                            <td>${a.question}</td>
                            <td>${a.answer}</td>
                            <td>${d.feedback || 'Chưa có'} <button class="feedback-btn" data-id="${doc.id}">Sửa</button></td>
                        `;
                        tbody.appendChild(row);
                    });
                });
                if (!hasData) tbody.innerHTML = "<tr><td colspan='8'>Không có dữ liệu.</td></tr>";
                updateSelectAll();
            } catch (e) {
                tbody.innerHTML = "<tr><td colspan='8'>Lỗi tải dữ liệu!</td></tr>";
            }
        }

        // === Event Listeners ===
        document.getElementById('filter-date').addEventListener('change', loadHistory);
        document.getElementById('filter-class').addEventListener('input', loadHistory);
        document.getElementById('filter-name').addEventListener('input', loadHistory);
        document.getElementById('filter-lesson').addEventListener('change', loadHistory);
        document.getElementById('delete-btn').addEventListener('click', () => {
            if (!document.querySelector('.row-checkbox:checked')) return alert('Chọn ít nhất 1 mục!');
            document.getElementById('password-modal').style.display = 'flex';
        });
        document.getElementById('cancel-btn').addEventListener('click', () => {
            document.getElementById('password-modal').style.display = 'none';
        });
        document.getElementById('confirm-delete-btn').addEventListener('click', async () => {
            if (document.getElementById('password-input').value !== '112') return alert('Sai mật khẩu!');
            const checks = document.querySelectorAll('.row-checkbox:checked');
            for (const c of checks) {
                const id = c.closest('tr').dataset.id;
                await deleteDoc(doc(db, 'testHistoryKaiwa', id));
            }
            document.getElementById('password-modal').style.display = 'none';
            loadHistory();
            alert('Đã xóa!');
        });

        // Feedback
        document.addEventListener('click', e => {
            if (e.target.classList.contains('feedback-btn')) {
                const id = e.target.dataset.id;
                const current = e.target.parentElement.textContent.replace('Sửa', '').trim();
                document.getElementById('feedback-input').value = current === 'Chưa có' ? '' : current;
                const modal = document.getElementById('feedback-modal');
                modal.style.display = 'flex';
                modal.dataset.docId = id;
            }
        });
        document.getElementById('feedback-cancel-btn').addEventListener('click', () => {
            document.getElementById('feedback-modal').style.display = 'none';
        });
        document.getElementById('feedback-save-btn').addEventListener('click', async () => {
            const modal = document.getElementById('feedback-modal');
            const id = modal.dataset.docId;
            await updateDoc(doc(db, 'testHistoryKaiwa', id), { feedback: document.getElementById('feedback-input').value });
            modal.style.display = 'none';
            loadHistory();
        });

        // Select All
        document.getElementById('select-all').addEventListener('change', e => {
            document.querySelectorAll('.row-checkbox').forEach(cb => cb.checked = e.target.checked);
        });
        function updateSelectAll() {
            const all = document.getElementById('select-all');
            const checks = document.querySelectorAll('.row-checkbox');
            all.checked = checks.length > 0 && Array.from(checks).every(c => c.checked);
        }

        loadHistory();
    </script>
</body>
</html>
